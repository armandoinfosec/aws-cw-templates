### PROPS.CONF ###
## $SPLUNK_HOME/etc/system/local/props.conf - https://docs.splunk.com/Documentation/Splunk/8.0.5/Admin/Propsconf

# This stanza looks at any source where the source name matches the format used by the AWS CloudWatch Logs input (region:log_group:instanceID).
# The expression used below has matches the "us-" or "us-gov-" strings used by AWS for US-based regions.
# Any Matches will be referred to their corresponding stanzas in transforms.conf. Please review your original source name(s) and update stanza as necessary.
# I used the timestamp lines to address some issues with my "_time" values not matching the timestamps in the event logs themselves. Uncomment those lines if you're having similar issues.
[source::(us-|us-gov-)*:*:i-*]
#TZ = UTC
#TIME_PREFIX=SystemTime='
#TIME_FORMAT=%Y-%m-%dT%H:%M:%S.%9N
#MAX_TIMESTAMP_LOOKAHEAD = 29
TRANSFORMS-HostAndSourceOverrideforAWSXMLWinEventLogs = WinEventXmlHostOverrideForAWS, WinEventXmlSourceOverrideForAWS

# This stanza looks at any source where the Azure Storage Table name is "WADWindowsEventLogsTable". This is the default table name for Windows Event Logs when enabled within the VM diagnostics portion of the Azure portal.
# Matches will be referred to their corresponding stanzas in transforms.conf. Please review your original source name(s) and update stanza as necessary.
# I used the timestamp lines to address some issues with my "_time" values not matching the timestamps in the event logs themselves. Uncomment those lines if you're having similar issues.
[source::...://WADWindowsEventLogsTable]
#TZ = UTC
#TIME_PREFIX=SystemTime='
#TIME_FORMAT=%Y-%m-%dT%H:%M:%S.%9N
#MAX_TIMESTAMP_LOOKAHEAD = 29
TRANSFORMS-RawXMLeventExtractionForAzureWindowsLogs = AzureTableStorage1XmlWinEventLogSourceOverride, AzureTableStorage2ToRawXmlWinEventLog, AzureTableStorage3XmlWinEventLogHostOverride

### TRANSFORMS.CONF ###
## $SPLUNK_HOME/etc/system/local/transforms.conf - https://docs.splunk.com/Documentation/Splunk/8.0.5/Admin/Transformsconf


# This stanza overrides the "host" value generated by the AWS TA and replaces it with the "Computer" value from the event log itself.
# Please refer to the transforms.conf documentation for more information regarding each of the lines in the stanza.
[WinEventXmlHostOverrideForAWS]
DEST_KEY = MetaData:Host
REGEX = <Computer>([^.<]+).*?<\/Computer>
FORMAT = host::$1
DEFAULT_VALUE = host::HOST:OVERRIDE:FAILED

# This stanza overrides the "source" value generated by the AWS TA and replaces it with the "Channel" value from the event log itself.
# Please refer to the transforms.conf documentation for more information regarding each of the lines in the stanza.
[WinEventXmlSourceOverrideForAWS]
SOURCE_KEY = _raw
DEST_KEY = MetaData:Source
REGEX = <Channel>([^.<]+).*?<\/Channel>
FORMAT = source::XmlWinEventLog:$1
DEFAULT_VALUE = source::SOURCE:OVERRIDE:FAILED

# This stanza overrides the "source" value generated by the Microsoft Cloud Services TA and replaces it with the "Channel" value from the event log itself.
# Please refer to the transforms.conf documentation for more information regarding each of the lines in the stanza.
[AzureTableStorage1XmlWinEventLogSourceOverride]
SOURCE_KEY = _raw
DEST_KEY = MetaData:Source
REGEX = <Channel>([^.<]+).*?<\/Channel>
FORMAT = source::XmlWinEventLog:$1
DEFAULT_VALUE = source::SOURCE:OVERRIDE:FAILED

# This stanza extracts the XML Windows Event Log from the Table Storage log and places it in the "_raw" field.
# Please refer to the transforms.conf documentation for more information regarding each of the lines in the stanza.
[AzureTableStorage2ToRawXmlWinEventLog]
SOURCE_KEY = _raw
DEST_KEY = _raw
REGEX = ^.*"RawXml": "(.*<\/Event>)"
FORMAT = $1
#DEFAULT_VALUE = RawXmlEventExtractionFailed

# This stanza overrides the "source" value generated by the Microsoft Cloud Services TA and replaces it with the "Computer" value from the event log itself.
# Please refer to the transforms.conf documentation for more information regarding each of the lines in the stanza.
[AzureTableStorage3XmlWinEventLogHostOverride]
SOURCE_KEY = _raw
DEST_KEY = MetaData:Host
REGEX = <Computer>([^.<]+).*?<\/Computer>
FORMAT = host::$1
#DEFAULT_VALUE = host::HOST:OVERRIDE:FAILED